### 英文構造解析アプリ再開発ロードマップ

**目標:** spaCyライブラリを活用し、学習者が英文の構造を直感的に理解できる、インタラクティブなWebアプリケーションを開発する。可視化と解説を核とし、段階的な情報提示を行うことで、あらゆるレベルの学習者をサポートする。

---

### フェーズ1: MVP (Minimum Viable Product) の構築

**ゴール:** 品詞タグ（粗い粒度）の色分け表示、主語-動詞の依存関係の矢印表示、簡単な解説ポップアップを実装し、コアとなる価値を迅速に提供する。

1.  **環境構築と基本設定:**
    *   `requirements.txt`の更新: `streamlit`, `spacy`, `graphviz` を追記。
    *   spaCyモデルのダウンロード: `en_core_web_sm` モデルをダウンロードするロジックを実装 (`@st.cache_resource` を使用)。
    *   Streamlitアプリの基本構造: `app.py`にタイトル、テキスト入力エリア、解析実行ボタンを配置。

2.  **基本解析機能の実装 (`analyze_sentence`):**
    *   入力テキストをspaCyで処理し、`TokenInfo` と `ChunkInfo` のデータモデルに従って解析結果を構造化データとして返す関数を実装する。
    *   **抽出情報:**
        *   **TokenInfo:** `id`, `text`, `lemma`, `pos_`, `tag_`, `dep`, `head_id`, `children_ids`, `is_root`
        *   **ChunkInfo (NPのみ):** `doc.noun_chunks` を利用して名詞句を抽出。

3.  **UI/UXの実装 (MVPレベル):**
    *   **品詞表示 (デフォルト):** `display_tokens_default` を実装し、品詞 (pos) ごとに色分けされた単語を表示する。
    *   **依存関係ツリー表示:** `display_dependency_tree` を実装し、Graphvizを用いて依存関係ツリーを表示する。
        *   **強調:** ROOT単語と、`nsubj` (主語) の関係のみを色や太さで強調する。
    *   **UI制御:**
        *   `st.spinner` で解析中のフィードバックを提示。
        *   `st.checkbox` で詳細表示のON/OFFを切り替えられるようにする（この段階では機能は限定的）。

---

### フェーズ2: 機能拡張とインタラクション強化

**ゴール:** 詳細な品詞情報の表示、主要な依存関係の追加、名詞句のハイライト表示を実装し、より深い分析を可能にする。

1.  **解析機能の強化 (`analyze_sentence`):**
    *   **句構造の拡充:**
        *   **動詞句 (VP) の推定:** ROOT動詞とその子 (aux, dobj, attrなど) をグループ化するカスタムロジックを実装。
        *   **前置詞句 (PP) の推定:** `ADP` (前置詞) とその `pobj` (目的語) をグループ化するカスタムロジックを実装。
        *   **副詞句 (ADVP) の推定:** `ADV` (副詞) を中心に関連語をグループ化するカスタムロジックを実装。
    *   抽出した句を `ChunkInfo` のリストに追加する。

2.  **UI/UXの強化:**
    *   **品詞表示 (詳細):** `display_tokens_detailed` を実装し、`st.popover` を使って各単語の詳細な品詞情報 (tag, lemmaなど) を表示する。
    *   **依存関係ツリーの強化:**
        *   `dobj` (直接目的語), `amod` (形容詞修飾) など、強調表示する依存関係の種類を増やす。
    *   **句構造のハイライト表示:** `display_chunks` を実装し、句の種類に応じて背景色を変えてハイライト表示する。
        *   ネストした句の表示にも対応する。
    *   **解説機能:** `st.popover` 内に、各品詞や依存関係の簡単な解説文を追加する。

---

### フェーズ3: 高度な可視化とユーザー体験の向上

**ゴール:** 親-子双方向性の強調、句構造の階層表示、練習問題機能などを追加し、本格的な学習ツールとしての完成度を高める。

1.  **解析機能とデータモデルの最終化:**
    *   不定詞句、分詞構文など、より複雑な構文の解析ロジックを検討・実装。
    *   必要に応じて、`TokenInfo`, `ChunkInfo` に解説文を生成するためのフィールドを追加。

2.  **UI/UXのさらなる洗練:**
    *   **インタラクティブなハイライト:** 解析結果の項目（ツリーのノード、句の一覧など）と、元のテキスト表示が双方向に連携し、クリックすると対応箇所がハイライトされる機能を実装 (JavaScript連携を検討)。
    *   **フィルタリング機能:** サイドバーに、表示する品詞や句の種類を絞り込むための `st.multiselect` を設置。
    *   **入力支援:** サンプル文章を提供するボタンを設置。
    *   **設定の永続化:** `st.session_state` を活用し、ユーザーの表示設定などを保持する。

3.  **練習問題機能 (オプション):**
    *   解析結果を基に、「この文の主語はどれですか？」といった簡単なクイズを自動生成する機能を検討。

---

**開発の進め方:**

*   各フェーズは独立して進めることができますが、前のフェーズの成果を基盤とします。
*   各機能の実装後には、必ずテストを行い、期待通りの動作をするか確認します。
*   Streamlit Cloudへのデプロイを意識し、開発中からパフォーマンスとリソース使用量を考慮します。

