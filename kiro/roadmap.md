### 英文構造解析アプリ再開発ロードマップ

**目標:** 小規模なspaCyモデルを使用し、インデントを用いて階層的に構造を明示的に示す英文構造解析アプリを開発する。特に、各要素の文法的な「役割」を明確に表示することに重点を置く。

---

**フェーズ1: コア機能の実装と階層表示の確立 (MVP)**
**（まずはこのフェーズの完了を目指します）**

1.  **環境構築と基本設定:**
    *   `requirements.txt`の更新: `spaCy`と`Streamlit`を追記。
    *   spaCyモデルのダウンロード: `en_core_web_sm`モデルをダウンロードするコマンドをREADMEに記載、またはアプリ内で初回起動時にダウンロードを促すロジックを実装。
    *   Streamlitアプリの基本構造: `app.py`に`st.set_page_config`、タイトル、テキスト入力エリア、解析実行ボタンを配置。

2.  **spaCyによる基本解析:**
    *   ユーザー入力テキストをspaCyで処理し、`Doc`オブジェクトを生成。
    *   各トークン（単語）の品詞（`token.pos_`、`token.tag_`）と依存関係（`token.dep_`、`token.head`）を取得。

3.  **「役割を明記した階層的な箇条書き」表示ロジックの実装 (パターン2-Bの簡易版):**
    *   **節の特定:** `doc.sents`で文を区切り、各文を「主節」として扱う。簡易的なルール（例: 従属接続詞で始まる文は「従属節」）で種類を判別。
    *   **句の特定:**
        *   **名詞句:** `doc.noun_chunks`を利用し、`chunk.root.dep_`から「主語」「目的語」などの役割を推定。
        *   **動詞句:** 各文のルート動詞を中心に、その子孫（目的語、補語、副詞など）を収集して動詞句を構築し、「述語」の役割を付与。
        *   **前置詞句:** `token.pos_ == "ADP"`のトークンを起点に、その`pobj`（前置詞の目的語）を収集。`prep.head`の品詞や前置詞の種類から「場所」「時」などの役割を推定。
    *   **単語と品詞:** 各句内の単語とその品詞を詳細に表示。
    *   **表示:** `st.markdown`とインデント（スペース）を用いて、階層的な箇条書きで結果を表示。

4.  **UI/UXの改善 (MVPレベル):**
    *   `@st.cache_resource`でspaCyモデルのロードをキャッシュし、パフォーマンスを確保。
    *   `st.spinner`で解析中のフィードバックをユーザーに提示。
    *   `st.expander`を各節（主節、従属節）のトップレベルに適用し、初期表示では閉じている状態にする。
    *   各句（名詞句、動詞句など）も`st.expander`でネストし、詳細を展開できるようにする。
    *   インデントを明確にするためのスペースを適切に挿入し、視覚的な階層を表現。

---

**フェーズ2: 複雑な構文への対応と役割の深化**

1.  **依存ツリーの再帰的走査による句・節の正確な特定:**
    *   spaCyの依存関係ツリーを再帰的に走査する関数を実装。
    *   `token.dep_`（依存関係ラベル）と`token.pos_`（品詞）をより詳細に活用し、句（名詞句、動詞句、形容詞句、副詞句、前置詞句）の正確な境界を特定。
    *   **不定詞句、分詞構文**の識別ロジックを追加。
    *   **多重従属節**（例: 関係節、名詞節、副詞節の入れ子）の識別と階層表示。

2.  **役割推定ロジックの強化:**
    *   各句や節が文中で果たす役割（主語、述語、目的語、補語、修飾語、原因、結果、目的、条件、譲歩、場所、時、方法など）を、依存関係ラベルや語彙的なヒントからより詳細かつ正確に推定するルールを実装。
    *   `get_noun_phrase_role`、`get_prepositional_phrase_role`などの補助関数を拡張。

3.  **UI/UXの強化:**
    *   **インタラクティブな文章のハイライト:** 解析結果の項目をクリックすると、元の文章の対応する部分がハイライトされる機能を検討（`unsafe_allow_html=True`とJavaScriptの組み合わせ）。
    *   **品詞・句・節ごとのフィルタリング:** サイドバーにフィルタリングオプションを追加し、ユーザーが特定の種類の情報に絞って表示できるようにする。
    *   **品詞・句・節の種類ごとの説明:** 各文法用語の横に情報アイコンを配置し、クリックすると説明が表示されるポップオーバー機能を実装。

---

**フェーズ3: 高度な機能とパフォーマンス最適化**

1.  **Transformerモデルの導入 (StanzaまたはspaCyの`en_core_web_trf`):**
    *   Stanzaを導入し、そのSRL（セマンティックロールラベリング）の結果を「役割」として直接利用するロジックを実装。これにより、役割推定の精度を大幅に向上させる。
    *   または、spaCyの`en_core_web_trf`モデルを使用し、より高精度な依存関係解析結果を基に、役割推定ルールをさらに洗練させる。
    *   モデルのロードとキャッシュ戦略を再確認し、パフォーマンスを最適化。

2.  **パフォーマンス最適化:**
    *   非常に長い文章に対する処理速度の改善（必要であれば、バックエンド処理の検討）。
    *   Streamlit Community Cloudでのデプロイを想定したリソース使用量の監視と調整。

3.  **UI/UXのさらなる洗練:**
    *   入力例とプリセット文章の提供。
    *   分析設定の柔軟性（分析の深さ、表示オプションの切り替え）。
    *   結果の要約と概要表示（総単語数、主要な品詞の統計など）。
    *   ユーザー補助機能（アクセシビリティ）の考慮。
    *   フィードバックフォームの設置。

---

**開発の進め方:**

*   各フェーズは独立して進めることができますが、前のフェーズの成果を基盤とします。
*   各機能の実装後には、必ずテストを行い、期待通りの動作をするか確認します。
*   Streamlit Community Cloudへのデプロイを意識し、開発中からパフォーマンスとリソース使用量を考慮します。